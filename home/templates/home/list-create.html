{% load static %}
<header class="page-header page-header-light page-header-light border-bottom bg-white mb-4">
  <div class="container">
      <div class="page-header-content pt-4">
          <div class="row align-items-center justify-content-between mb-3">
              <div class="col-auto mt-4">
                <h1 class="page-header-title">
                  Create a list
                </h1>
              </div>
              <div class="col-12 col-xl-auto mb-3">
                <a class="" href="#">
                  <div class="page-header-subtitle"><a href="" id="save_list">Save List</a></div>
                </a>
              </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="form-group">
                <input class="form-control form-control-solid" id="list_name" type="text" placeholder="Name your list here" />
              </div>
            </div>
          </div>
      </div>
  </div>
</header>
<!-- Main page content-->
<div class="container">

  <div id="list">

  </div>

  <div class="card mb-5">
    <div class="card-header">
      <div class="col-12 col-xl-auto mb-3">
        <a class="btn btn-primary p-2" id="add-field" href="javascript:void(0);">Add Field</a>
      </div>
    </div>
    <div class="card-body">
      <form>
        <div class="row">
          <div class="col-lg-8">
            <div class="form-group">
              <label for="field-label">Field Label</label>
              <input class="form-control" id="field-label" type="text" placeholder="Field label">
            </div>
          </div>
          <div class="col-lg-4">
            <div class="form-group">
                <label for="field-type">Field type</label>
                <select class="form-control" id="field-type" placeholder="Select option">
                    <option value="" selected disabled hidden>Select one</option>
                    <option value="text">Text</option>
                    <option value="long-text">Long Text</option>
                    <option value="number">Number</option>
                </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-12">
            <div class="custom-control custom-checkbox custom-control-solid">
              <input class="custom-control-input" id="required" type="checkbox" name="required">
              <label class="custom-control-label" for="required">Required</label>
            </div>
            <div class="custom-control custom-checkbox custom-control-solid">
              <input class="custom-control-input" id="visible" type="checkbox" name="visible">
              <label class="custom-control-label" for="visible">Visible</label>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Include JS here that does not need template tags -->
<script src="{% static 'js/list-create.js' %}"></script>
<!-- Include JS here that needs template tags -->
<script>

  (function($) {
    $('#save_list').on('click', function(e) {
        e.preventDefault();

        let fields = JSON.parse(localStorage.getItem('fields'))
        let removed = JSON.parse(localStorage.getItem('removed'))

        let list_name = $('#list_name').val()

        $.ajax({
          type: "POST",
          dataType: 'json',
          {% if list_id %}
          url: "{% url 'update_list' organization_pk=organization.pk app_pk=app.pk list_pk=list_id %}",
          {% else %}
          url: "{% url 'save_list' organization_pk=organization.pk app_pk=app.pk %}",
          {% endif %}
            data: {
                'list_name': list_name,
                'fields': JSON.stringify(fields),
                'removed': JSON.stringify(removed),
                'csrfmiddlewaretoken': window.CSRF_TOKEN // from index.html
            },
            success: function(data) {

              console.log(data)

              if (data.success) {
                getPage('{% url 'lists' organization_pk=organization.pk app_pk=app.pk %}');
              } else {
                alert("There was an error, please try again!")
              }

            },
            error: function(xhr, status, error) {
                // shit happens friends!
            }
        });
    });
  }(jQuery));

  {% if list_id %}
  // Load the list fields if in list edit mode
  $( document ).ready(function(){
    $.ajax({
        url: "{% url 'list_fields' organization_pk=organization.pk app_pk=app.pk list_pk=list_id %}",
        type: 'get',
        dataType: 'json',
        success: function(data){

            // Update the name of the list
            $('#list_name').val(data.name)

            // Save fields to local storage
            $.each(data.fields, function(index, field) {
              field['editMode'] = false;
            });
            localStorage.setItem('fields', JSON.stringify(data.fields))

            // Display the list
            refreshFieldDisplay()

        },
        error: function (xhr, ajaxOptions, thrownError) {
            var errorMsg = 'Ajax request failed: ' + xhr.responseText;
            console.log(errorMsg)
          }
    });
  });
  {% endif %}

</script>
